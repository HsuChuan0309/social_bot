<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chatbot 全螢幕（5 次互動後解鎖）</title>
  <script src="https://www.gstatic.com/dialogflow-console/fast/messenger/bootstrap.js?v=1"></script>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      background: #ffffff;
    }
    /* 讓聊天窗填滿整個畫面 */
    df-messenger {
      --df-messenger-chat-window-width: 100vw;
      --df-messenger-chat-window-height: 100vh;
      --df-messenger-chat-background-color: white;
      --df-messenger-bot-message: #f1f1f1;
      --df-messenger-user-message: #cfe9ff;
      --df-messenger-font-color: black;
      position: fixed;
      inset: 0;
    }
    .hint {
      position: fixed;
      top: 10px;
      left: 12px;
      font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Noto Sans, Arial, "Noto Sans TC", "PingFang TC", "Heiti TC", "Microsoft JhengHei", sans-serif;
      font-size: 14px;
      color: #666;
      z-index: 1;
      background: rgba(255,255,255,0.7);
      padding: 6px 10px;
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <div class="hint">🌟 請至少輸入 5 次訊息，達成後會自動解鎖下一頁</div>

  <df-messenger
    intent="WELCOME"
    chat-title="0806"
    agent-id="236034eb-ea4a-47e7-b0c8-202f144d704e"
    language-code="zh-tw"
    expand="true">
  </df-messenger>

  <script>
    // 計算「使用者發送文字」的次數 —— 達到 5 次就通知父頁面
    let userTurnCount = 0;
    const REQUIRED_TURNS = 5;
    let unlocked = false;

    window.addEventListener("message", (event) => {
      const data = event.data || {};

      // Dialogflow Messenger 載入事件
      if (data.eventType === "dfMessengerLoaded") {
        console.log("💬 Chatbot 已載入");
      }

      // 收到一次 agent 的回應事件；裡面同時會帶上當次 request 的 queryInput
      if (data.eventType === "dfResponse") {
        // 僅當使用者有輸入純文字時才計數
        if (data.queryInput && data.queryInput.text && data.queryInput.text.text) {
          userTurnCount += 1;
          console.log("使用者輸入次數:", userTurnCount);

          if (!unlocked && userTurnCount >= REQUIRED_TURNS) {
            unlocked = true;
            // 通知父頁面（Qualtrics）可以顯示下一頁按鈕
            window.parent.postMessage("show-next-button", "*");
            console.log("✅ 已達到 5 次，已通知父頁面顯示下一頁按鈕");
            // 顯示完成提示
            const hint = document.querySelector(".hint");
            if (hint) hint.textContent = "✅ 條件達成，可以進入下一頁";
          }
        }
      }
    });
  </script>
</body>
</html>
