<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chatbot 全螢幕（5 次互動後解鎖 / 強化版）</title>
  <script src="https://www.gstatic.com/dialogflow-console/fast/messenger/bootstrap.js?v=1"></script>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      background: #ffffff;
    }
    df-messenger {
      --df-messenger-chat-window-width: 100vw;
      --df-messenger-chat-window-height: 100vh;
      --df-messenger-chat-background-color: white;
      --df-messenger-bot-message: #f1f1f1;
      --df-messenger-user-message: #cfe9ff;
      --df-messenger-font-color: black;
      position: fixed;
      inset: 0;
    }
    .hint {
      position: fixed;
      top: 10px;
      left: 12px;
      font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Noto Sans, Arial, "Noto Sans TC", "PingFang TC", "Heiti TC", "Microsoft JhengHei", sans-serif;
      font-size: 14px;
      color: #666;
      z-index: 1;
      background: rgba(255,255,255,0.7);
      padding: 6px 10px;
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <div class="hint">🌟 請至少輸入 5 次訊息，達成後會自動解鎖下一頁</div>

  <df-messenger
    intent="WELCOME"
    chat-title="0806"
    agent-id="236034eb-ea4a-47e7-b0c8-202f144d704e"
    language-code="zh-tw"
    expand="true">
  </df-messenger>

  <script>
    let userTurnCount = 0;
    const REQUIRED_TURNS = 5;
    let unlocked = false;

    function unlockIfReady() {
      if (!unlocked && userTurnCount >= REQUIRED_TURNS) {
        unlocked = true;
        const msg = "show-next-button";
        // 通知父與最上層（有些平台的 iframe 巢狀結構不同）
        try { window.parent.postMessage(msg, "*"); } catch (e) {}
        try { window.top.postMessage(msg, "*"); } catch (e) {}
        const hint = document.querySelector(".hint");
        if (hint) hint.textContent = "✅ 條件達成，可以進入下一頁";
      }
    }

    // 1) 使用者按下送出時（官方事件名稱）
    window.addEventListener("message", (event) => {
      const data = event.data || {};
      if (data.eventType === "dfUserInputEntered") {
        // data.queryInput?.text?.text
        const t = data.queryInput && data.queryInput.text && data.queryInput.text.text;
        if (t && t.trim().length > 0) {
          userTurnCount += 1;
          unlockIfReady();
        }
      }
    });

    // 2) 備援：在收到 dfResponse 時，也從 queryInput 判斷是否為使用者文字
    window.addEventListener("message", (event) => {
      const data = event.data || {};
      if (data.eventType === "dfResponse") {
        const t = data.queryInput && data.queryInput.text && data.queryInput.text.text;
        if (t && t.trim().length > 0) {
          userTurnCount += 1;
          unlockIfReady();
        }
      }
    });

    // 3) 最後備援：超過一定時間或偵測到 10 則訊息時，仍未解鎖就主動放行（避免受試者被卡住）
    setTimeout(() => {
      if (!unlocked) {
        try { window.parent.postMessage("show-next-button", "*"); } catch (e) {}
        try { window.top.postMessage("show-next-button", "*"); } catch (e) {}
        const hint = document.querySelector(".hint");
        if (hint) hint.textContent = "⚠️ 時間到，自動允許繼續";
      }
    }, 10 * 60 * 1000); // 10 分鐘保險機制
  </script>
</body>
</html>
